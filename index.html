<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Smart Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root{
      --bg: #0b0f14;
      --card: #121821;
      --muted: #9fb0c3;
      --text: #e6eef7;
      --accent: #4ba3ff;
      --accent-2:#7dd3fc;
      --border: #1e2632;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --btn:#1a2330;
      --btn-hover:#223144;
      --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8fb; --card:#ffffff; --muted:#546a82; --text:#0b1220;
        --accent:#2563eb; --accent-2:#0ea5e9; --border:#e7edf5; --btn:#eef3f9; --btn-hover:#e3ecf7;
        --shadow: 0 10px 30px rgba(0,0,0,.05), inset 0 1px 0 rgba(255,255,255,.6);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 600px at 100% -150px, rgba(75,163,255,.15), transparent 60%),
      radial-gradient(1000px 500px at -200px 40%, rgba(14,165,233,.12), transparent 60%), var(--bg);
      color:var(--text); font: 15px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .container{max-width:1100px; margin:32px auto; padding:0 16px}
    .header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:18px}
    .title{display:flex; gap:12px; align-items:center}
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border);
      border-radius:999px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      box-shadow: var(--shadow);
    }
    .dot{width:10px; height:10px; border-radius:999px; background:var(--warn); box-shadow:0 0 0 3px rgba(245,158,11,.15)}
    .status-good .dot{background:var(--good); box-shadow:0 0 0 3px rgba(34,197,94,.15)}
    .status-bad .dot{background:var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.15)}
    .grid{display:grid; gap:16px; grid-template-columns: 1.2fr 1fr}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)) , var(--card);
      border:1px solid var(--border); border-radius:18px; padding:16px 16px 14px; box-shadow:var(--shadow)
    }
    .card h3{margin:0 0 8px 0; font-size:16px}
    .sub{color:var(--muted); font-size:13px}
    code{background:rgba(148,163,184,.12); border:1px solid var(--border); padding:2px 6px; border-radius:6px}
    .row{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .btn{
      appearance:none; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0)), var(--btn);
      color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer; box-shadow: var(--shadow);
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{background:var(--btn-hover)}
    .btn:active{transform: translateY(1px)}
    .btn-primary{
      background: linear-gradient(180deg, rgba(59,130,246,.25), rgba(59,130,246,.08)), var(--btn);
      border-color: color-mix(in oklab, var(--accent) 40%, var(--border));
    }
    .btn-ghost{background:transparent}
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(148,163,184,.12); border:1px solid var(--border)
    }
    .kpi{display:flex; gap:10px; align-items:baseline}
    .kpi .value{font-weight:600; font-size:18px}
    .list{margin:8px 0 0 0; padding:0; list-style:none; max-height:220px; overflow:auto}
    .list li{display:flex; gap:8px; padding:8px 0; border-bottom:1px dashed var(--border)}
    .list li:last-child{border-bottom:none}
    .topic{font-weight:600}
    .ts{color:var(--muted); font-size:12px}
    .imgWrap{position:relative; overflow:hidden; border-radius:14px; border:1px solid var(--border); box-shadow:var(--shadow)}
    .imgWrap img{display:block; width:100%; height:auto}
    .skeleton{
      position:absolute; inset:0; background:
        linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.08) 50%, rgba(255,255,255,0) 100%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      background-size: 200% 100%, 100% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer{0%{background-position: -200% 0, 0 0} 100%{background-position: 200% 0, 0 0}}
    .footer{margin-top:14px; display:flex; align-items:center; justify-content:space-between; color:var(--muted); font-size:12px}
    .small{font-size:12px; color:var(--muted)}
    .spacer{flex:1}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="title">
        <div style="font-size:26px"> MQTT + Camera Dashboard</div>
        <span id="connBadge" class="badge"><span class="dot"></span><span id="connText">Connecting‚Ä¶</span></span>
      </div>
      <div class="row">
        <span class="pill">Broker: <code>Mqtt Borker</code></span>
      </div>
    </header>

    <section class="grid">
      <!-- Live MQTT -->
      <div class="card" id="mqttCard">
        <h3>üì® Live Data</h3>
        <div class="row" style="margin-top:6px">
          <div class="kpi">
            <span class="sub">Latest message</span>
            <span class="value" id="mqttData">Waiting‚Ä¶</span>
          </div>
          <span class="spacer"></span>
          <span class="small" id="lastMsgTs">‚Äì</span>
        </div>

        <ul class="list" id="msgList"></ul>

        <div class="footer">
          <div class="row">
            <button class="btn btn-ghost" id="clearBtn">üßπ Clear</button>
            <button class="btn" id="pauseBtn" aria-pressed="false">‚è∏Ô∏è Pause</button>
            <button class="btn btn-primary" id="getDataBtn">üì§ Get SmartJar Data</button>
          </div>
        </div>
      </div>

      <!-- Camera -->
      <div class="card">
        <h3>üì∑ Remote Camera</h3>
        <div class="row" style="margin:8px 0 12px 0">
          <button class="btn btn-primary" id="captureBtn">üì∏ Capture Image</button>
          <span class="sub">Image updates after capture</span>
        </div>

        <div class="imgWrap">
          <div class="skeleton" id="imgSkeleton" aria-hidden="true"></div>
          <img id="preview" src="https://bd9b20171165.ngrok-free.app/latest.jpg?ts=0" alt="Latest capture">
        </div>

        <div class="footer">
          <span class="small">Source: <code>/latest.jpg</code></span>
          <span class="small" id="imgTs">ts=0</span>
        </div>
      </div>
    </section>

    <p class="small" style="margin-top:12px">Tip: Press <strong>c</strong> to capture, <strong>p</strong> to pause stream.</p>
  </div>

  <script>
    // ====== CONFIG ======
    const MQTT_BROKER = 'wss://e7ffb68b7a584515a2243f84f41ca7.s1.eu.hivemq.cloud:8884/mqtt';
    const IMAGE_URL   = 'https://1965bb033c05.ngrok-free.app/latest.jpg';
    const CAPTURE_URL = 'https://1965bb033c05.ngrok-free.app/capture';
    const TOPIC       = 'test/topic';
    const SMARTJAR_TOPIC = 'smartjar/command';
    const SMARTJAR_DATA_TOPIC = 'smartjar/data';

    // ====== UI helpers ======
    const $ = (s) => document.querySelector(s);
    const connBadge = $('#connBadge');
    const connText  = $('#connText');
    const mqttData  = $('#mqttData');
    const lastMsgTs = $('#lastMsgTs');
    const msgList   = $('#msgList');
    const pauseBtn  = $('#pauseBtn');
    const clearBtn  = $('#clearBtn');
    const captureBtn= $('#captureBtn');
    const getDataBtn= $('#getDataBtn');
    const img       = $('#preview');
    const imgSkeleton = $('#imgSkeleton');
    const imgTs     = $('#imgTs');

    const state = { paused:false, messages:[], maxMessages: 30 };

    function setConnStatus(status){
      connBadge.classList.remove('status-good','status-bad');
      if(status==='connected'){ connBadge.classList.add('status-good'); connText.textContent='Connected'; }
      else if(status==='error'){ connBadge.classList.add('status-bad'); connText.textContent='Error'; }
      else if(status==='reconnecting'){ connBadge.classList.remove('status-good','status-bad'); connText.textContent='Reconnecting‚Ä¶'; }
      else { connText.textContent='Connecting‚Ä¶'; }
    }

    function pushMessage(topic, text){
      const ts = new Date();
      mqttData.textContent = text;
      lastMsgTs.textContent = ts.toLocaleTimeString();
      state.messages.unshift({topic, text, ts});
      if(state.messages.length > state.maxMessages) state.messages.pop();
      renderList();
    }

    function renderList(){
      msgList.innerHTML = '';
      state.messages.forEach(({topic,text,ts})=>{
        const li = document.createElement('li');
        li.innerHTML = `
          <div style="width:8px; height:8px; border-radius:8px; background: var(--accent); margin-top:8px"></div>
          <div style="flex:1">
            <div class="topic">${topic}</div>
            <div>${escapeHtml(text)}</div>
            <div class="ts">${ts.toLocaleString()}</div>
          </div>
        `;
        msgList.appendChild(li);
      });
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function setImgLoading(on){
      imgSkeleton.style.display = on ? 'block' : 'none';
    }

    function refreshImage(){
      setImgLoading(true);
      const stamp = Date.now();
      img.src = `${IMAGE_URL}?ts=${stamp}`;
      imgTs.textContent = `ts=${stamp}`;
    }

    // ====== MQTT connection ======
    const client = mqtt.connect(MQTT_BROKER, {
      username: 'bharadwaj',
      password: 'IoTtest1',
      clientId: 'client_' + Math.random().toString(16).substr(2, 8),
      protocol: 'wss',
      port: 8884,
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 4000
    });

    client.on('connect', () => {
      setConnStatus('connected');
      client.subscribe([TOPIC, SMARTJAR_DATA_TOPIC], err => {
        if (err) console.error('Subscribe error:', err);
      });
    });

    client.on('reconnect', () => setConnStatus('reconnecting'));
    client.on('error', () => setConnStatus('error'));
    client.on('close', () => setConnStatus('reconnecting'));

    client.on('message', (topic, message) => {
      if(state.paused) return;
      pushMessage(topic, message.toString());
    });

    // ====== Camera capture ======
    async function captureImage(){
      try{
        captureBtn.disabled = true;
        captureBtn.textContent = '‚è≥ Capturing‚Ä¶';
        await fetch(CAPTURE_URL, { method: "POST" });
        refreshImage();
      }catch(err){
        console.error('Error triggering capture:', err);
        alert('Capture failed. See console for details.');
      }finally{
        setTimeout(()=>{
          captureBtn.disabled = false;
          captureBtn.textContent = 'üì∏ Capture Image';
        }, 600);
      }
    }

    // ====== SmartJar Command ======
    getDataBtn.addEventListener('click', () => {
      client.publish(SMARTJAR_TOPIC, 'get_data', { qos: 0, retain: false }, (err) => {
        if (err) {
          console.error("‚ùå Failed to send SmartJar command:", err);
          alert("Failed to send SmartJar command");
        } else {
          console.log("‚úÖ SmartJar command sent!");
        }
      });
    });

    // Bind capture to button
    captureBtn.addEventListener('click', captureImage);

    // Image loading states
    img.addEventListener('load', () => setImgLoading(false));
    img.addEventListener('error', () => { setImgLoading(false); alert('Failed to load image.'); });

    // Controls
    pauseBtn.addEventListener('click', ()=>{
      state.paused = !state.paused;
      pauseBtn.setAttribute('aria-pressed', String(state.paused));
      pauseBtn.textContent = state.paused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
    });

    clearBtn.addEventListener('click', ()=>{
      state.messages = [];
      renderList();
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(e.key.toLowerCase()==='c') captureImage();
      if(e.key.toLowerCase()==='p') pauseBtn.click();
    });

    // Initial image shimmer until first load
    setImgLoading(true);
  </script>
</body>
</html>
